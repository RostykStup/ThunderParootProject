<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Delivery_Page</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</head>
<body>

<!--<a class="waves-effect waves-light btn modal-trigger" href="#modal1">Modal</a>-->
<button data-target="modal1" class="btn modal-trigger">Create</button>
<div id="modal1" class="modal">
    <div class="modal-content">
        <input type="text" id="delivery-name" placeholder="Name">
        <input type="text" id="delivery-id" style="display: none">
        <button id="delivery-create-button" class="btn" >Create</button>
        <button id="close-button" class = "btn" style="background-color: white; color: black">Cancel</button>
    </div>
</div>

<script>
    $(document).ready(function(){
        $('.modal').modal();
    });
    $('#delivery-create-button').click(() => {
        let id = $('#delivery-id').val();
        if(id === ''){
            let request = {
                name: $('#delivery-name').val()
            }
            $.ajax({
                url: 'http://localhost:8080/delivery',
                contentType: 'application/json',
                type: 'post',
                data: JSON.stringify(request),
                success: function (response) {
                    console.log('post', response);
                    $('.modal').modal('close');
                    $('#delivery-name').val('');
                    location.reload();
                    // redrawTable();
                }
            });
        } else {
            let request = {
                id:$('#delivery-id').val(),
                name: $('#delivery-name').val()
            }
            $.ajax({
                url: 'http://localhost:8080/delivery?id='+id,
                contentType: 'application/json',
                type: 'put',
                data: JSON.stringify(request),
                success: function (response) {
                    console.log('update', response);
                    $('.modal').modal('close');
                    $('#delivery-name').val('');
                    $('#delivery-id').val('');
                    location.reload();
                    // redrawTable();
                }
            });

        }
    });

    $('#close-button').click(() => {
        $('.modal').modal('close');
        $('#delivery-name').val('');
        $('#delivery-id').val('');
    });

</script>

<table id="deliveries_table">
    <thead>
    <tr>
        <th>Id</th>
        <th>Name</th>
        <th>Actions</th>
    </tr>
    </thead>
    <tbody id="deliveries">

    </tbody>
</table>

<script>
    redrawTable();
    function redrawTable() {
        $("#deliveries tr").remove();
        $.ajax({
            url: 'http://localhost:8080/delivery',
            type: 'get',
            success: function (response) {
                for (let delivery of response) {
                    appendDeliveryToTable(delivery);
                }
                actionsOnDeleteButton();
                actionsOnUpdateButton()
            }

        })
    }
    function appendDeliveryToTable(delivery) {
        $('#deliveries').append(`
            <tr>
             <td class="delivery-id-col">${delivery.id}</td>
             <td class="delivery-name-col">${delivery.name}</td>
                 <td>
                  <button value="${delivery.id}" class="delete-btn btn">Delete
                  </button>
                 <button value="${delivery.id}" class="update-btn btn">Update
                 </button>
                  </td>
             </tr>
        `);
    };

    function actionsOnDeleteButton() {
        $('.delete-btn').click((e) =>{
            let id = e.target.value;
            $.ajax({
                url: 'http://localhost:8080/delivery?id='+id,
                type: 'delete',
                success: function () {
                    console.log('deleted');
                    location.reload();
                    // redrawTable();
                }
            })
        });
    };

    function actionsOnUpdateButton() {
        $('.update-btn').click((e) =>{
            let id = e.target.value;
            let $btn = $(e.target);
            $('#delivery-name').val($btn.parent().siblings('.delivery-name-col').html());
            $('#delivery-id').val(id);
            $('.modal').modal('open');
        });
    };
</script>
</body>
</html>